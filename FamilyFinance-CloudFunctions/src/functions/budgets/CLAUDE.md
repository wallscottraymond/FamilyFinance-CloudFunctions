# Budget System - Cloud Functions

## ⚠️ RBAC System Migration (2025-01)

**IMPORTANT**: The Budget System is being updated to support the new RBAC (Role-Based Access Control) and group-based sharing system.

### Upcoming Changes:
- **Budget interface** will add ownership and sharing fields (`createdBy`, `ownerId`, `sharing`)
- **BudgetPeriodDocument** will inherit sharing from parent budget
- Legacy `familyId` field will remain for backward compatibility during migration
- **Security rules** will be updated to check resource-level permissions
- **Cloud Functions** will need permission validation before operations

### Current Status:
- Phase 1 (Types) completed - Backend types updated in `/src/types/`
- Phase 2 (Resource Updates) in progress
- See `/RBAC_IMPLEMENTATION_STATUS.md` for detailed migration status

### For Detailed Architecture:
- See main `/CLAUDE.md` for RBAC system architecture
- Review `/src/types/sharing.ts` for sharing interfaces
- Check `/src/types/users.ts` for system role capabilities

---

## Overview

The Budget System is a comprehensive budget management module that enables users to create, track, and manage personal and shared budgets with granular period-based tracking. It supports multiple budget types, automatic period generation, real-time spending calculations, and detailed checklist-based tracking.

### Core Concept: Budgets as Blueprints

**Budgets are blueprints** that define how budget periods should be configured:
- Budgets specify the **template** (amount, categories, settings)
- Budget periods are **instances** created from that template
- **Users primarily interact with budget_periods** after budget creation
- Budgets provide the configuration; periods provide the tracking

**Example:**
- Budget: "Groceries" with $500/month for Food categories
- Budget Periods: Monthly instances (Jan: $500, Feb: $500, Mar: $500, etc.)
- User interacts with: Individual period documents to track spending, add checklist items, modify amounts

## Architecture

### Module Structure

```
budgets/
├── api/                    # Public-facing Cloud Functions
│   ├── crud/              # Create, Read, Update, Delete operations
│   ├── queries/           # Budget query functions
│   ├── periods/           # Period management functions
│   └── checklist/         # Checklist item CRUD operations
├── orchestration/         # Background automation
│   ├── triggers/          # Firestore triggers
│   └── scheduled/         # Scheduled cron jobs
├── utils/                 # Shared business logic
├── types/                 # TypeScript type definitions
└── config/                # Configuration constants
```

### Key Concepts

**Budgets (`budgets` collection):**
- **Blueprint/template** for budget period configuration
- Define amount, categories, period type, and settings
- Can be **personal (individual user)** or **shared (family/group)**
- Support recurring (ongoing) or limited (fixed end date) types
- **Automatically generate `budget_periods` when created**
- Users typically create once and rarely modify

**Budget Periods (`budget_periods` collection):**
- **Primary user interaction point** for budget tracking
- Time-based budget allocations derived from budget blueprint
- Three period types: Monthly, Bi-Monthly, Weekly
- Proportional amount allocation based on period type
- Track actual spending vs allocated amount
- Support checklist items for granular tracking
- Can be **personal (no familyId)** or **shared (with familyId)**
- Users interact with these daily (add checklist items, view spending, modify amounts)

**Source Periods (`source_periods` collection):**
- Single source of truth for all period definitions
- Pre-generated by admin functions
- Ensures consistency across budgets and recurring outflows

**Checklist Items:**
- Granular task tracking within budget periods
- Track expected vs actual spending for specific items
- Embedded in `budget_periods` documents (max 20 per period)

**Personal vs Shared Budgets:**
- **Personal Budgets:** Created by individual users, `familyId` is undefined or empty
  - Only the creator can access and modify
  - Budget periods created without familyId
  - Used by individuals tracking their own finances
- **Shared Budgets:** Created for family/group collaboration, `familyId` is set
  - Multiple users (family members) can access
  - Budget periods inherit familyId from budget
  - Used when families/groups collaborate on finances (future feature)
  - Currently, family functionality is not fully implemented

### Budget → Budget Period Relationship

```
Budget (Blueprint)
├── name: "Groceries"
├── amount: 500 (monthly base amount)
├── categoryIds: ["food", "groceries"]
├── budgetType: "recurring"
├── familyId: undefined (personal) OR "family_123" (shared)
└── Creates → Budget Periods (Instances)
    ├── 2025-M01: $500 allocated, $0 spent, [checklist items]
    ├── 2025-M02: $500 allocated, $0 spent, [checklist items]
    ├── 2025-M03: $500 allocated, $0 spent, [checklist items]
    ├── 2025-BM01-1: $250 allocated (bi-monthly half)
    ├── 2025-BM01-2: $250 allocated (bi-monthly half)
    ├── 2025-W01: $114.90 allocated (weekly proportion)
    └── ... (all period types for the year)
```

**User Workflow:**
1. **Setup Phase:** User creates budget (blueprint) once
2. **Automatic Generation:** System creates 1 year of budget_periods
3. **Daily Usage:** User interacts with budget_periods (not budget)
   - View current period spending
   - Add/check off checklist items
   - Modify period amounts as needed
   - Track progress toward goals

## Data Models

### Budget Document (Blueprint)

```typescript
interface Budget {
  id: string;
  name: string;                    // Budget name
  description: string;             // Optional description
  familyId?: string;               // Set for shared budgets, undefined/empty for personal
  createdBy: string;               // User ID who created the budget
  amount: number;                  // Monthly budget amount (BASE BLUEPRINT AMOUNT)
  currency: string;                // Currency code (e.g., "USD")
  categoryIds: string[];           // Transaction categories this budget tracks
  period: BudgetPeriod;            // Display period (WEEKLY, MONTHLY, etc.)
  budgetType: 'recurring' | 'limited'; // Budget duration type

  // Date fields
  startDate: Timestamp;            // Budget start date
  endDate: Timestamp;              // Legacy field (period end)
  isOngoing: boolean;              // Whether budget continues indefinitely
  budgetEndDate?: Timestamp;       // Actual end date for limited budgets

  // Tracking fields (LEGACY - spending tracked in budget_periods)
  spent: number;                   // Total amount spent (legacy)
  remaining: number;               // Amount remaining (legacy)
  alertThreshold: number;          // Alert percentage (default: 80)

  // Access control
  memberIds: string[];             // Users with access to this budget
  isShared: boolean;               // Whether budget is shared with family/group
  isActive: boolean;               // Whether budget is active

  // Period management (populated by onBudgetCreate trigger)
  activePeriodRange?: {
    startPeriod: string;           // First period ID
    endPeriod: string;             // Last period ID
  };
  periodsGeneratedUntil?: Timestamp; // For recurring budgets
  canExtendPeriods?: boolean;      // Whether periods can be extended
  needsScheduledExtension?: boolean; // Flag for scheduled extension
  lastExtended?: Timestamp;        // Last period extension timestamp

  // System fields
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

### Budget Period Document (User Interaction Point)

```typescript
interface BudgetPeriodDocument {
  id: string;                      // Format: "{budgetId}_{periodId}"
  budgetId: string;                // Reference to parent budget (blueprint)
  periodId: string;                // Period identifier (e.g., "2025-W01")
  sourcePeriodId: string;          // Reference to source_periods document
  familyId: string;                // Family association (empty string if personal)

  // Ownership
  userId: string;                  // Budget owner
  createdBy: string;               // User who created the budget

  // Period context
  periodType: PeriodType;          // WEEKLY, BI_MONTHLY, MONTHLY
  periodStart: Timestamp;          // Period start date
  periodEnd: Timestamp;            // Period end date (alias: startDate, endDate)

  // Budget amounts (DERIVED FROM BLUEPRINT)
  allocatedAmount: number;         // Amount allocated for this period (from budget blueprint)
  originalAmount: number;          // Original allocated amount (before modifications)
  modifiedAmount?: number;         // User-modified amount (if isModified = true)
  spent?: number;                  // Actual spending (calculated from transactions)
  remaining?: number;              // Remaining amount (allocatedAmount - spent)

  // Budget metadata (denormalized for performance)
  budgetName: string;              // Budget name (from parent budget)

  // Checklist items (USER INTERACTION FEATURE)
  checklistItems: ChecklistItem[]; // Array of checklist items (max 20)

  // User modifications (USER INTERACTION FEATURE)
  isModified: boolean;             // Whether user modified the allocated amount
  userNotes?: string;              // User notes for this period
  lastModifiedBy?: string;         // User who last modified
  lastModifiedAt?: Timestamp;      // Last modification timestamp

  // System fields
  createdAt: Timestamp;
  updatedAt: Timestamp;
  lastCalculated?: Timestamp;      // Last spending calculation
  isActive: boolean;               // Whether period is active
}
```

**Note on familyId field:**
- Personal budget periods: `familyId` is empty string `""`
- Shared budget periods: `familyId` is set to the family/group ID
- This field is inherited from the parent budget blueprint
- Currently used for future family/group collaboration features

### Checklist Item

```typescript
interface ChecklistItem {
  id: string;                      // Unique identifier
  name: string;                    // Item name/description
  transactionSplit: string;        // Future: Link to transaction split
  expectedAmount: number;          // Budgeted amount for this item
  actualAmount: number;            // Actual amount spent
  isChecked: boolean;              // Completion status
}
```

## API Functions

### CRUD Operations

#### `createBudget` (HTTP POST)
**Endpoint:** `https://us-central1-{project}.cloudfunctions.net/createBudget`
**Auth:** Editor or Admin role required
**Purpose:** Create a new budget blueprint (automatically generates budget_periods)

**Request Body:**
```json
{
  "name": "Grocery Budget",
  "description": "Monthly grocery spending",
  "amount": 500,
  "categoryIds": ["cat_food", "cat_groceries"],
  "period": "MONTHLY",
  "budgetType": "recurring",
  "startDate": "2025-01-01T00:00:00Z",
  "isOngoing": true,
  "isShared": false,
  "alertThreshold": 80
}
```

**Personal vs Shared Budgets:**
- **Personal Budget:** Set `isShared: false`, do not include familyId
  - Uses user's preferred currency from their profile
  - Only creator has access
  - Budget periods created with empty familyId
- **Shared Budget:** Set `isShared: true` (future feature - requires family implementation)
  - User must belong to a family
  - Uses family's currency settings
  - All family members can access
  - Budget periods created with familyId

**Triggers:** `onBudgetCreate` trigger automatically generates budget_periods

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "budget_abc123",
    "name": "Grocery Budget",
    ...
  }
}
```

**What Happens:**
1. Budget blueprint created in `budgets` collection
2. `onBudgetCreate` trigger fires automatically
3. 1 year of budget_periods generated (monthly, bi-monthly, weekly)
4. Historical spending calculated from existing transactions
5. User can immediately interact with budget_periods

#### `updateBudget` (HTTP PATCH)
**Purpose:** Update budget blueprint properties
**Auth:** Owner or Admin
**Allowed Updates:** name, description, amount, categoryIds, alertThreshold, isActive
**Note:** Changing amount affects future budget_periods only (existing periods unchanged unless manually modified)

#### `deleteBudget` (HTTP DELETE)
**Purpose:** Soft delete a budget blueprint (sets isActive = false)
**Auth:** Owner or Admin
**Effect:** Associated budget_periods also marked inactive

#### `getBudget` (HTTP GET)
**Purpose:** Get a single budget blueprint by ID
**Query Params:** `budgetId`
**Use Case:** Rare - typically users view budget_periods, not the budget itself

### Query Functions

#### `getUserBudgets` (HTTP GET)
**Purpose:** Get all budget blueprints where user is a member
**Auth:** Viewer role required
**Filters:** Active budgets only, user in memberIds
**Includes:** Automatic spending calculation and update
**Use Case:** Settings screen to manage budget blueprints
**Returns:** Both personal and shared budgets for the user

#### `getPersonalBudgets` (HTTP GET)
**Purpose:** Get user's personal budget blueprints (non-shared)
**Auth:** Viewer role required
**Filters:**
  - createdBy = userId
  - isShared = false
  - familyId is undefined or empty
**Returns:** Only personal budgets created by and for the individual user

#### `getFamilyBudgets` (HTTP GET)
**Purpose:** Get family's/group's shared budget blueprints
**Auth:** Viewer role required
**Requirement:** User must belong to a family/group
**Filters:**
  - familyId = user's family
  - isShared = true
**Note:** Family/group functionality is a future feature

#### `getBudgetSummary` (HTTP GET)
**Purpose:** Get comprehensive budget summary with period data
**Query Params:** `budgetId`, `periodId` (optional)
**Returns:** Budget details, current period spending, checklist items
**Use Case:** Budget detail view showing blueprint + current period

### Period Management

#### `extendBudgetPeriods` (Callable Function)
**Purpose:** Create budget_periods for a specific period (edge cases only)
**Auth:** Viewer role required
**Usage:** Rarely needed since periods are created upfront from blueprint

**Request:**
```typescript
{
  periodId: "2025-M01",        // Target period ID
  familyId?: "family_xyz"      // Optional family context (future feature)
}
```

**Response:**
```typescript
{
  success: true,
  budgetPeriodsCreated: 5,
  budgetsExtended: ["budget_1", "budget_2"],
  error?: string
}
```

**Behavior:**
- If `familyId` provided: Extends shared budgets for that family
- If no `familyId`: Extends personal budgets for the authenticated user

#### `extendBudgetPeriodsRange` (Callable Function)
**Purpose:** Create budget_periods for a date range
**Auth:** Viewer role required
**Usage:** Bulk period generation for multiple budgets

### Checklist Operations (Primary User Interaction)

All checklist functions are callable Firebase Functions (v2) and operate on **budget_periods** (not budgets).

#### `addChecklistItem` (Callable)
**Purpose:** Add new checklist item to budget period
**Auth:** Budget period owner only
**User Interaction:** Daily use - adding specific spending goals to period

**Request:**
```typescript
{
  budgetPeriodId: "budget_123_2025-M01",  // Specific period instance
  checklistItem: {
    name: "Organic vegetables",
    expectedAmount: 50,
    actualAmount: 0,
    isChecked: false,
    transactionSplit: ""
  }
}
```

**Response:**
```typescript
{
  success: true,
  checklistItem: {
    id: "checklist_abc",
    name: "Organic vegetables",
    expectedAmount: 50,
    actualAmount: 0,
    isChecked: false,
    transactionSplit: ""
  },
  message: "Checklist item added successfully"
}
```

#### `updateChecklistItem` (Callable)
**Purpose:** Update existing checklist item
**Auth:** Budget period owner only
**User Interaction:** Daily use - updating spending amounts, marking items complete

**Request:**
```typescript
{
  budgetPeriodId: "budget_123_2025-M01",
  checklistItemId: "checklist_abc",
  updates: {
    actualAmount: 45,
    isChecked: true
  }
}
```

#### `toggleChecklistItem` (Callable)
**Purpose:** Toggle isChecked status
**Auth:** Budget period owner only
**User Interaction:** Quick completion marking

**Request:**
```typescript
{
  budgetPeriodId: "budget_123_2025-M01",
  checklistItemId: "checklist_abc"
}
```

#### `deleteChecklistItem` (Callable)
**Purpose:** Remove checklist item from budget period
**Auth:** Budget period owner only

**Request:**
```typescript
{
  budgetPeriodId: "budget_123_2025-M01",
  checklistItemId: "checklist_abc"
}
```

## Orchestration Functions

### Triggers

#### `onBudgetCreate` (Firestore Trigger)
**Triggered by:** Document creation in `budgets` collection
**Purpose:** Transform budget blueprint into budget_period instances
**Memory:** 512MiB, Timeout: 60s

**Process:**
1. Determine start date (from budget.startDate or selectedStartPeriod)
2. Calculate end date based on budget type:
   - Recurring: 1 year from start (12 months worth of periods)
   - Limited: Until budgetEndDate or endDate
3. Query source_periods within date range
4. Create budget_period instances with proportional amounts:
   - Monthly: Full budget amount (1.0 × blueprint amount)
   - Bi-Monthly: 50% of budget amount (0.5 × blueprint amount)
   - Weekly: (7 / 30.44) × blueprint amount
5. Set familyId on each period instance:
   - Personal budgets: familyId = "" (empty string)
   - Shared budgets: familyId = budget.familyId
6. Batch create budget_periods in Firestore
7. Update budget with activePeriodRange metadata
8. Recalculate spending from existing transactions

**Period Generation Examples:**
- Recurring budget starting Jan 1, 2025: Creates ~78 period instances
  - 12 monthly periods (Jan-Dec)
  - 24 bi-monthly periods (Jan 1-15, Jan 16-31, etc.)
  - 52 weekly periods (W01-W52)
- Limited budget Jan 1 - Mar 31: Creates ~20 period instances
  - 3 monthly periods
  - 6 bi-monthly periods
  - 13 weekly periods

**Blueprint → Instance Transformation:**
```
Personal Budget Blueprint:
{
  name: "Groceries",
  amount: 500,  // Base monthly amount
  categoryIds: ["food", "groceries"],
  budgetType: "recurring",
  isShared: false,
  familyId: undefined
}

↓ onBudgetCreate Trigger ↓

Budget Period Instances Created:
- 2025-M01: allocatedAmount: 500, familyId: "" (personal)
- 2025-M02: allocatedAmount: 500, familyId: "" (personal)
- 2025-BM01-1: allocatedAmount: 250, familyId: "" (personal)
- 2025-BM01-2: allocatedAmount: 250, familyId: "" (personal)
- 2025-W01: allocatedAmount: 114.90, familyId: "" (personal)
- ... (78 total instances created)
```

### Scheduled Functions

#### `extendRecurringBudgetPeriods` (Scheduled)
**Schedule:** `0 2 1 * *` (Monthly on the 1st at 2:00 AM UTC)
**Purpose:** Extend recurring budget blueprints before current periods run out
**Memory:** 512MiB, Timeout: 120s

**Process:**
1. Find recurring budget blueprints where needsScheduledExtension = true
2. Check if current period range is within 30 days of expiration
3. Generate 12 more months of budget_period instances from blueprint
4. Update budget blueprint metadata (activePeriodRange, periodsGeneratedUntil)
5. Works for both personal and shared budgets

## Utility Functions

### Budget Periods (`utils/budgetPeriods.ts`)

#### `createBudgetPeriodsFromSource()`
**Purpose:** Create budget_period instances from budget blueprint + source_periods
**Returns:** CreateBudgetPeriodsResult with counts and IDs

**Parameters:**
- `db`: Firestore instance
- `budgetId`: Budget document ID
- `budget`: Budget blueprint object
- `startDate`: Period generation start date
- `endDate`: Period generation end date

**Process:**
1. Query source_periods in date range
2. Calculate allocated amount for each period type (using blueprint amount)
3. Create BudgetPeriodDocument instance objects
4. Set familyId from budget (empty string for personal, family ID for shared)
5. Return result with period counts and range

**Amount Calculation Logic:**
```typescript
// Blueprint: amount = 500 (monthly base)

// Monthly instance:
allocatedAmount = 500 × 1.0 = 500

// Bi-Monthly instance:
allocatedAmount = 500 × 0.5 = 250

// Weekly instance:
allocatedAmount = 500 × (7 / 30.44) = 114.90
```

#### `batchCreateBudgetPeriods()`
**Purpose:** Efficiently create multiple budget_period instances using batch writes
**Handles:** Firestore's 500 document batch limit

#### `updateBudgetPeriodRange()`
**Purpose:** Update budget blueprint with period range metadata
**Sets:** activePeriodRange, lastExtended, periodsGeneratedUntil (for recurring)

### Period Amount Allocation (`utils/calculatePeriodAllocatedAmount.ts`)

#### `calculatePeriodAllocatedAmount()`
**Purpose:** Calculate the allocated budget amount based on actual days in each period
**Location:** Single source of truth for period amount allocation
**Used by:** All budget period creation and extension functions

**Function Signature:**
```typescript
export function calculatePeriodAllocatedAmount(
  budgetAmount: number,
  budgetPeriodType: PeriodType,
  targetPeriod: SourcePeriod
): number
```

**Parameters:**
- `budgetAmount`: The budget amount in its original period type (from budget blueprint)
- `budgetPeriodType`: The period type of the budget blueprint (MONTHLY, BI_MONTHLY, WEEKLY)
- `targetPeriod`: The target source period to calculate allocation for

**Returns:** The allocated amount for the target period based on actual days

**Day-Based Allocation Logic:**

The allocation is calculated based on the actual number of days in each period to ensure spending aligns correctly across all views:

1. **For Monthly budgets converting to other periods:**
   - **Day-by-day iteration:** Loops through each day in the target period
   - **Month-specific daily rate:** Each day uses its month's daily rate (budgetAmount / days in that month)
   - **Handles month-spanning:** Weeks or bi-monthly periods spanning multiple months get accurate allocations
   - **Example:** Week with 3 days in Feb (28 days, $1/day) + 4 days in Mar (31 days, $0.90/day) = $3 + $3.60 = $6.60

2. **For Weekly budgets converting to other periods:**
   - **Fixed daily rate:** budgetAmount / 7
   - **Simple multiplication:** Daily rate × days in target period

3. **For Bi-monthly budgets converting to other periods:**
   - **Period-specific daily rate:** budgetAmount / actual days in that bi-monthly period (15 or 13-16)
   - **Simple multiplication:** Daily rate × days in target period

**Key Examples:**

**Example 1: Monthly budget viewed as bi-monthly**
```typescript
// February budget: $28/month → $1/day (28 days in Feb)
// Bi-monthly period 1 (Feb 1-15): 15 days × $1/day = $15
// Bi-monthly period 2 (Feb 16-28): 13 days × $1/day = $13
// Total: $15 + $13 = $28 ✓ (correctly sums to monthly budget)
```

**Example 2: Monthly budget viewed as weekly (spanning months)**
```typescript
// February: $28/month → $1.00/day (28 days in Feb)
// March: $28/month → $0.90/day (31 days in March)
// Weekly period spanning both months:
//   - 3 days in Feb: 3 × $1.00 = $3.00
//   - 4 days in March: 4 × $0.90 = $3.60
//   - Total: $6.60 for that week ✓
```

**Example 3: Weekly budget viewed as monthly**
```typescript
// Weekly budget: $70/week → $10/day
// February (28 days): (28/7) × $70 = 4 weeks × $70 = $280
// March (31 days): (31/7) × $70 = 4.43 weeks × $70 = $310
```

**Example 4: Weekly budget viewed as bi-monthly**
```typescript
// Weekly budget: $70/week → $10/day
// Bi-monthly period (15 days): 15 × $10 = $150
// Bi-monthly period (16 days): 16 × $10 = $160
```

**Design Decision:**

This day-based approach was implemented to solve a critical alignment issue:

**Problem:** Using average day calculations (like 7/30.44 for weekly) caused spending to misalign across different period views. A user tracking a $100/month budget would see different total spending when switching between monthly, bi-monthly, and weekly views.

**Solution:** Calculate based on actual days in each specific period. This ensures:
- **Perfect alignment:** Spending totals match regardless of view (monthly, bi-monthly, weekly)
- **Accurate representation:** February with 28 days allocates less than March with 31 days
- **Correct bi-monthly splits:** First half (1-15) and second half (16-end) correctly reflect actual days
- **Multi-month week handling:** Weeks spanning multiple months correctly allocate from each month's budget

**Historical Context:**

This utility was created to eliminate code duplication across 5 different files and fix an inconsistency:

1. `utils/budgetPeriods.ts` - Used average-based calculation
2. `functions/budgets/utils/budgetPeriods.ts` - Used average-based calculation
3. `api/periods/extendBudgetPeriods.ts` - Used average-based calculation
4. `api/periods/extendBudgetPeriodsRange.ts` - Used average-based calculation
5. `orchestration/scheduled/extendRecurringBudgetPeriods.ts` - **Had different implementation using actual days**

The centralized utility now provides:
- **Single source of truth** for day-based amount allocation
- **Consistency** across all budget period generation
- **Accurate calculations** using actual period days
- **Maintainability** - change formula in one place
- **Testability** - unit test independently

#### `getDailyRate()`
**Purpose:** Calculate the daily spending rate for a budget amount and period type
**Parameters:**
- `budgetAmount`: The budget amount
- `budgetPeriodType`: The period type (MONTHLY, BI_MONTHLY, WEEKLY)
- `periodDays`: Optional specific days in the period

**Returns:** Daily spending rate for the budget

**Use Case:** Calculating daily budgets, projecting spending, or debugging allocation calculations

### Budget Spending (`utils/budgetSpending.ts`)

#### `updateBudgetSpending()`
**Purpose:** Update budget_period instances when transactions change
**Called by:** Transaction triggers (onCreate, onUpdate, onDelete)

**Process:**
1. Calculate spending deltas from old vs new transaction
2. Extract budget spending from transaction splits
3. Find matching budget_period instances by transaction date
4. Update spent and remaining amounts atomically

**Key Logic:**
- Only approved expense transactions count toward spending
- Transactions mapped to period instances by date range (inclusive)
- Multiple period types updated if transaction date overlaps
- Atomic batch updates ensure consistency
- Works for both personal and shared budget periods

**Example:**
```typescript
// Budget Blueprint: "Groceries" with $500/month (personal budget)
// Transaction on Jan 15, 2025 for $50 in Groceries category
// Updates 3 budget_period instances:
// - 2025-M01 (Monthly: Jan 1-31): spent += 50
// - 2025-BM01-1 (Bi-Monthly: Jan 1-15): spent += 50
// - 2025-W03 (Weekly: Jan 13-19): spent += 50
```

#### `recalculateBudgetSpendingOnCreate()`
**Purpose:** Calculate initial spending when budget blueprint is created
**Called by:** `onBudgetCreate` trigger

**Process:**
1. Find ALL approved expense transactions for user
2. Filter transactions by budget categoryIds
3. Map transactions to budget_period instances by date
4. Update period instance spending in batch

**Performance:** Processes historical transactions efficiently using batch operations

## Configuration

### Period Configuration (`config/periodConfig.ts`)

```typescript
// Average days in a month for weekly allocation
const AVG_DAYS_IN_MONTH = 30.44;

// Period amount multipliers (applied to blueprint amount)
const PERIOD_MULTIPLIERS = {
  MONTHLY: 1.0,                    // Full budget amount
  BI_MONTHLY: 0.5,                 // Half budget amount
  WEEKLY: 7 / AVG_DAYS_IN_MONTH,   // ~0.2298 (22.98%)
};

// Batch operation limits
const BATCH_LIMITS = {
  FIRESTORE_BATCH_SIZE: 500,       // Max documents per batch
  MAX_CHECKLIST_ITEMS: 20,         // Max checklist items per period instance
};

// Extension settings
const EXTENSION_SETTINGS = {
  RECURRING_PERIOD_MONTHS: 12,     // Generate 1 year at a time
  SCHEDULED_EXTENSION_CRON: '0 2 1 * *', // Monthly at 2 AM UTC
};
```

## Security Rules

### Budget Collection (Blueprint)

```javascript
match /budgets/{budgetId} {
  // Read access - Blueprint configuration
  allow read: if isAuthenticated() && (
    // Budget creator (for personal budgets)
    resource.data.createdBy == request.auth.uid ||
    // Family member for shared budgets (future feature)
    (resource.data.isShared == true &&
     resource.data.familyId != null &&
     resource.data.familyId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.familyId) ||
    // User is in memberIds
    request.auth.uid in resource.data.memberIds
  );

  // Create access - Editor or Admin role
  allow create: if isAuthenticated() &&
                   hasRole('editor') &&
                   request.resource.data.createdBy == request.auth.uid;

  // Update access - Budget owner or Admin (blueprint modifications)
  allow update: if isAuthenticated() && (
    resource.data.createdBy == request.auth.uid ||
    hasRole('admin')
  ) && isValidBudgetUpdate();

  // Delete access - Budget owner or Admin
  allow delete: if isAuthenticated() && (
    resource.data.createdBy == request.auth.uid ||
    hasRole('admin')
  );
}

function isValidBudgetUpdate() {
  let allowedFields = [
    'name', 'description', 'amount', 'categoryIds',
    'alertThreshold', 'isActive', 'updatedAt',
    'activePeriodRange', 'lastExtended', 'periodsGeneratedUntil',
    'canExtendPeriods', 'needsScheduledExtension'
  ];

  let changedFields = request.resource.data.diff(resource.data).affectedKeys();
  return changedFields.hasOnly(allowedFields);
}
```

### Budget Periods Collection (User Interaction Point)

```javascript
match /budget_periods/{periodId} {
  // Read access - Period instance data (primary user interaction)
  allow read: if isAuthenticated() && (
    // Personal budget period - user must be the owner
    resource.data.userId == request.auth.uid ||
    // Shared budget period - user must be in the family (future feature)
    (resource.data.familyId != '' &&
     resource.data.familyId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.familyId)
  );

  // Create access - Cloud Functions only (created from blueprint)
  allow create: if false;

  // Update access - Budget owner only for specific fields (USER MODIFICATIONS)
  allow update: if isAuthenticated() &&
                   resource.data.userId == request.auth.uid &&
                   isValidBudgetPeriodUpdate();

  // Delete access - Budget owner or Admin
  allow delete: if isAuthenticated() && (
    resource.data.userId == request.auth.uid ||
    hasRole('admin')
  );
}

function isValidBudgetPeriodUpdate() {
  // Only allow user modification fields (not blueprint-derived fields)
  let allowedFields = [
    'userNotes', 'modifiedAmount', 'isModified',
    'lastModifiedBy', 'lastModifiedAt',
    'checklistItems', 'updatedAt'
  ];

  let changedFields = request.resource.data.diff(resource.data).affectedKeys();
  let validFieldChanges = changedFields.hasOnly(allowedFields);

  // Ensure core blueprint-derived fields don't change
  let coreFieldsUnchanged =
    request.resource.data.budgetId == resource.data.budgetId &&
    request.resource.data.periodId == resource.data.periodId &&
    request.resource.data.userId == resource.data.userId;

  // Validate checklist items if they're being updated
  let checklistValid = !changedFields.hasAny(['checklistItems']) ||
                       isValidChecklistItems(request.resource.data.checklistItems);

  return validFieldChanges && coreFieldsUnchanged && checklistValid;
}

function isValidChecklistItems(checklistItems) {
  return checklistItems is list &&
         checklistItems.size() <= 20 && // Max 20 items
         checklistItems.all(item => isValidChecklistItem(item));
}

function isValidChecklistItem(item) {
  return item is map &&
         item.keys().hasAll(['id', 'name', 'transactionSplit',
                             'expectedAmount', 'actualAmount', 'isChecked']) &&
         item.id is string && item.id.size() > 0 &&
         item.name is string && item.name.size() > 0 && item.name.size() <= 100 &&
         item.transactionSplit is string &&
         item.expectedAmount is number && item.expectedAmount >= 0 &&
         item.actualAmount is number && item.actualAmount >= 0 &&
         item.isChecked is bool;
}
```

## Firestore Indexes

### Required Composite Indexes

```json
{
  "indexes": [
    {
      "collectionGroup": "budgets",
      "fields": [
        { "fieldPath": "createdBy", "order": "ASCENDING" },
        { "fieldPath": "isActive", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "budgets",
      "fields": [
        { "fieldPath": "createdBy", "order": "ASCENDING" },
        { "fieldPath": "isShared", "order": "ASCENDING" },
        { "fieldPath": "isActive", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "budgets",
      "fields": [
        { "fieldPath": "familyId", "order": "ASCENDING" },
        { "fieldPath": "isActive", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "budgets",
      "fields": [
        { "fieldPath": "memberIds", "arrayConfig": "CONTAINS" },
        { "fieldPath": "isActive", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "budget_periods",
      "fields": [
        { "fieldPath": "budgetId", "order": "ASCENDING" },
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "isActive", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "budget_periods",
      "fields": [
        { "fieldPath": "budgetId", "order": "ASCENDING" },
        { "fieldPath": "periodId", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "budget_periods",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "periodType", "order": "ASCENDING" },
        { "fieldPath": "periodStart", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "budgets",
      "fields": [
        { "fieldPath": "budgetType", "order": "ASCENDING" },
        { "fieldPath": "needsScheduledExtension", "order": "ASCENDING" },
        { "fieldPath": "isActive", "order": "ASCENDING" }
      ]
    }
  ]
}
```

## Frontend Integration

### React Native Example

```typescript
import { getFunctions, httpsCallable } from '@react-native-firebase/functions';
import { getFirestore, collection, query, where, onSnapshot } from '@react-native-firebase/firestore';

const functions = getFunctions();
const db = getFirestore();

// Create a new PERSONAL budget BLUEPRINT (rarely done - setup phase)
async function createPersonalBudget(budgetData) {
  try {
    const response = await fetch(
      'https://us-central1-{project}.cloudfunctions.net/createBudget',
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify({
          ...budgetData,
          isShared: false  // Personal budget
          // familyId is not set for personal budgets
        })
      }
    );

    const result = await response.json();
    return result.data;
  } catch (error) {
    console.error('Error creating budget:', error);
    throw error;
  }
}

// Subscribe to BUDGET PERIOD INSTANCES (daily usage - primary interaction)
function subscribeToBudgetPeriods(budgetId, userId, callback) {
  const q = query(
    collection(db, 'budget_periods'),
    where('budgetId', '==', budgetId),
    where('userId', '==', userId),
    where('isActive', '==', true)
  );

  return onSnapshot(q, (snapshot) => {
    const periods = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    callback(periods);
  });
}

// Get personal budget periods (no family filter needed)
function subscribeToPersonalBudgetPeriods(userId, callback) {
  const q = query(
    collection(db, 'budget_periods'),
    where('userId', '==', userId),
    where('familyId', '==', ''),  // Empty string for personal budgets
    where('isActive', '==', true)
  );

  return onSnapshot(q, (snapshot) => {
    const periods = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    callback(periods);
  });
}

// Add checklist item to PERIOD INSTANCE (daily usage)
async function addChecklistItem(budgetPeriodId, item) {
  try {
    const addItem = httpsCallable(functions, 'addChecklistItem');
    const result = await addItem({
      budgetPeriodId,  // Specific period instance, not budget blueprint
      checklistItem: item
    });
    return result.data;
  } catch (error) {
    console.error('Error adding checklist item:', error);
    throw error;
  }
}

// Get current period INSTANCE for a budget
function getCurrentPeriod(budget, periodType = 'MONTHLY') {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');

  switch (periodType) {
    case 'MONTHLY':
      return `${year}-M${month}`;
    case 'BI_MONTHLY':
      const day = now.getDate();
      const half = day <= 15 ? '1' : '2';
      return `${year}-BM${month}-${half}`;
    case 'WEEKLY':
      // Calculate ISO week number
      const weekNum = getISOWeek(now);
      return `${year}-W${String(weekNum).padStart(2, '0')}`;
  }
}

// Example: Personal Budget screen showing current period instance
function PersonalBudgetDetailScreen({ budgetId }) {
  const [budgetBlueprint, setBudgetBlueprint] = useState(null);
  const [currentPeriod, setCurrentPeriod] = useState(null);

  useEffect(() => {
    // Get budget blueprint (for settings/configuration)
    const fetchBlueprint = async () => {
      const blueprint = await getBudget(budgetId);
      setBudgetBlueprint(blueprint);
    };

    // Subscribe to current period instance (for daily tracking)
    const periodId = getCurrentPeriod(budgetBlueprint, 'MONTHLY');
    const unsubscribe = subscribeToSinglePeriod(budgetId, periodId, setCurrentPeriod);

    fetchBlueprint();
    return () => unsubscribe();
  }, [budgetId]);

  return (
    <View>
      {/* Blueprint info (rarely changed) */}
      <Text>Budget: {budgetBlueprint?.name}</Text>
      <Text>Monthly Amount: ${budgetBlueprint?.amount}</Text>
      <Text>Type: {budgetBlueprint?.isShared ? 'Shared' : 'Personal'}</Text>

      {/* Current period instance (daily interaction) */}
      <Text>Current Period: {currentPeriod?.periodId}</Text>
      <Text>Allocated: ${currentPeriod?.allocatedAmount}</Text>
      <Text>Spent: ${currentPeriod?.spent}</Text>
      <Text>Remaining: ${currentPeriod?.remaining}</Text>

      {/* Checklist items (user adds/checks these daily) */}
      <ChecklistItems items={currentPeriod?.checklistItems} />
    </View>
  );
}
```

## Common Workflows

### Creating a New Personal Budget (Setup Phase)

1. **User creates budget blueprint** via `createBudget` API
   - Defines name, amount, categories, type
   - Sets `isShared: false` for personal budget
   - This is a one-time setup action
2. **`onBudgetCreate` trigger fires** automatically
   - Transforms blueprint into period instances
3. **Budget period instances generated** from source_periods
   - 1 year of monthly, bi-monthly, and weekly instances created
   - All instances have `familyId: ""` (empty string for personal)
4. **Historical spending calculated** from existing transactions
   - Instances populated with actual spending data
5. **User can now interact** with budget_period instances
   - View current period spending
   - Add checklist items
   - Track progress

**User never touches the budget blueprint again** unless changing configuration.

### Daily Budget Tracking (Primary User Interaction)

1. **User opens budget screen** → Views current budget_period instance
2. **User adds checklist item** to period instance via `addChecklistItem`
3. **User makes purchase** → Transaction created
4. **Transaction trigger** calls `updateBudgetSpending()`
5. **Matching budget_period instances updated** based on transaction date
6. **Real-time listeners** update mobile UI immediately
7. **User sees** updated spending in period instance

**All user interaction is with budget_period documents, not budget blueprint.**

### Monthly Period Extension (Recurring Budgets)

1. **Scheduled function runs** on 1st of month at 2 AM UTC
2. **Checks recurring budget blueprints** near period expiration (both personal and shared)
3. **Uses blueprint to generate 12 more months** of budget_period instances
4. **Updates budget blueprint metadata** (activePeriodRange, etc.)
5. **User always has** future period instances available for planning

### Checklist Management (Daily User Activity)

1. **User opens budget period instance** → Sees checklist items
2. **Adds new item** via `addChecklistItem` to specific period instance
3. **Updates amounts** as spending occurs via `updateChecklistItem`
4. **Toggles completion** via `toggleChecklistItem`
5. **Tracks progress** toward period goals

**Checklist items exist in period instances, not in budget blueprint.**

## Performance Considerations

### Optimization Strategies

**Period Instance Generation:**
- Batch writes (500 documents per batch)
- Parallel processing where possible
- Efficient date range queries on indexed fields

**Spending Calculations:**
- Date-based filtering reduces period instance scans
- Atomic batch updates for consistency
- Denormalized budgetName avoids joins with blueprint

**Real-time Updates:**
- Firestore listeners for live period instance data
- Client-side caching reduces reads
- Minimal document size (embed checklist, max 20 items)

### Scaling Limits

**Budget Period Instances per Budget Blueprint:**
- Typical: ~78 period instances per year (12M + 24BM + 52W)
- Maximum: Depends on budget duration
- Cleanup: Archive old period instances after 2 years (future enhancement)

**Checklist Items:**
- Maximum: 20 items per budget_period instance
- Document size: Well within Firestore 1MB limit
- Performance: Array operations efficient at this scale

**Transaction Processing:**
- Spending updates: O(n) where n = matching period instances (typically 1-3)
- Batch size: 500 documents per write
- Concurrency: Handled by Firestore transactions

## Error Handling

### Common Errors

**"No source periods found in date range"**
- **Cause:** Admin hasn't generated source_periods for requested timeframe
- **Solution:** Run `generateSourcePeriods` admin function
- **Prevention:** Generate periods 2+ years in advance

**"User must belong to a family to create shared budgets"**
- **Cause:** User not assigned to family but trying to create shared budget blueprint
- **Solution:** Create personal budget instead (family feature coming later)
- **Note:** Currently, most users will create personal budgets

**"Invalid category IDs"**
- **Cause:** CategoryIds don't exist in categories collection
- **Solution:** Use valid category IDs from transaction categories

**"Permission denied: You can only modify your own budget periods"**
- **Cause:** User trying to modify another user's budget_period instance
- **Solution:** Ensure authentication and ownership checks

### Debugging Tips

**Budget period instances not showing:**
```bash
# Check if source_periods exist
firebase firestore:get source_periods

# Check budget blueprint document for activePeriodRange
firebase firestore:get budgets/{budgetId}

# Verify familyId field on budget periods
firebase firestore:get budget_periods/{periodId}

# View function logs
firebase functions:log --only onBudgetCreate
```

**Spending not updating on period instances:**
```bash
# Check transaction splits have correct budgetId
firebase firestore:get transactions/{transactionId}

# View spending update logs
firebase functions:log | grep "updateBudgetSpending"

# Manually recalculate (admin function)
firebase functions:call recalculateBudgetSpending --data '{"budgetId":"..."}'
```

**Checklist items not saving to period instance:**
```bash
# Verify budget_period ownership
firebase firestore:get budget_periods/{periodId}

# Check function logs
firebase functions:log --only addChecklistItem

# Test security rules
firebase emulators:start --only firestore
```

## Development Guidelines

### Adding New Budget Features

1. **Update types** in `types/budget.types.ts`
2. **Determine if feature belongs to:**
   - Budget blueprint (rare configuration changes)
   - Budget period instances (common user interactions)
3. **Consider personal vs shared budgets:**
   - Will feature work for individuals?
   - Will it need modification for family/group feature later?
4. **Modify Cloud Functions** in appropriate `api/` subdirectory
5. **Update security rules** in `firestore.rules`
6. **Add indexes** in `firestore.indexes.json` if needed
7. **Update this documentation** with new features
8. **Test thoroughly** in emulator environment

### Testing Budget Functions

```bash
# Start emulator suite
firebase emulators:start --only functions,firestore,auth

# Run budget function tests
cd FamilyFinance-CloudFunctions
npm test -- budgets

# Test specific function
firebase functions:shell
> createBudget({name: "Test", amount: 100, isShared: false, ...})
```

### Best Practices

**Budget Blueprint Creation:**
- Always validate categoryIds against categories collection
- Set sensible defaults (alertThreshold: 80, budgetType: 'recurring')
- Handle both personal and shared budgets appropriately
- For now, most budgets will be personal (isShared: false)
- Include comprehensive error messages

**Period Instance Management:**
- Trust source_periods as single source of truth
- Never manually create period instance documents
- Use batch operations for bulk creates/updates
- Maintain period metadata on budget blueprint documents
- Ensure familyId is set correctly (empty string for personal, family ID for shared)

**Spending Calculations:**
- Always use transaction date for period instance matching
- Filter by approved + expense transactions only
- Update atomically using batch writes
- Log detailed spending calculation steps

**Checklist Items:**
- Enforce 20 item limit for document size
- Validate all required fields
- Use embedded documents in period instances (not subcollections)
- Provide clear user feedback on errors

**User Interaction Patterns:**
- Most user interactions are with budget_period instances, not budgets
- Budget blueprints are configuration (rarely changed after creation)
- Period instances are daily tracking tools (frequently accessed and modified)
- Currently focus on individual/personal user experience
- Design with future family/group collaboration in mind

## Future Enhancements

### Family/Group Collaboration (Planned)

**Shared Budgets:**
- Users can create/join families or groups
- Shared budgets accessible to all family members
- Budget periods inherit family context
- Collaborative checklist management
- Family-wide spending tracking

**Implementation Considerations:**
- familyId field already exists in data models
- Security rules already support family-based access
- Frontend needs family creation/management UI
- Backend needs family CRUD operations

### Other Planned Features

**Transaction Split Integration:**
- Link checklist items in period instances to specific transaction splits
- Automatic actualAmount updates when linked transactions created
- Visual connection between checklist and transactions

**Budget Analytics:**
- Spending trends over time across period instances (by period type)
- Category breakdown within budget blueprints
- Budget vs actual reporting across all period instances
- Predictive budget suggestions based on historical period data

**Rollover Budgets:**
- Carry remaining amount from one period instance to next
- Configurable rollover limits in budget blueprint
- Rollover history tracking across period instances

**Budget Templates:**
- Save budget blueprint configurations as templates
- Quick budget creation from templates
- Shared family budget templates (when family feature implemented)

**Advanced Notifications:**
- Threshold alerts on period instances (80%, 90%, 100%)
- Period expiration warnings
- Checklist completion reminders for period instances
- Smart spending insights based on period patterns

## Notes for AI Assistants

- **Budgets are blueprints/templates** - they define configuration
- **Budget periods are instances** - they are what users interact with daily
- **Most user operations target budget_periods** - not budgets
- **Budgets can be personal or shared** - personal budgets have no familyId (or empty string), shared budgets have familyId set
- **Currently, focus is on personal budgets** - family/group functionality is planned for later
- **familyId field uses empty string for personal** - not null or undefined, use `""` for personal budget periods
- **Always check source_periods exist** before creating budget blueprints for specific date ranges
- **Use batch operations** for bulk budget_period instance creation/updates
- **Validate ownership** before any budget or budget_period modifications
- **Calculate proportional amounts correctly** based on period type from blueprint amount (MONTHLY: 1.0, BI_MONTHLY: 0.5, WEEKLY: 7/30.44)
- **Match transaction dates to period instance ranges** (inclusive) for spending updates
- **Respect 20 item limit** for checklist items in period instances
- **Use proper TypeScript types** from centralized type definitions
- **Log comprehensively** for debugging period generation and spending calculations
- **Test security rules** thoroughly when modifying access patterns
- **Document breaking changes** and migration strategies
- **Remember the blueprint/instance relationship** when designing new features
- **Budget blueprints are rarely accessed** after creation - focus UX on period instances
- **Design for individuals first** - family features come later but keep the architecture flexible
