# Outflows System - Cloud Functions

## Overview

The Outflows System is a recurring bill management module that enables users to create, track, and monitor recurring expenses (bills) with automatic period-based withholding calculations. It supports both Plaid-synced recurring transactions and user-created bills, with automatic period generation and financial planning features.

### Core Concept: Outflows as Recurring Bills

**Outflows are recurring bills** that need regular tracking and planning:
- Outflows define the **recurring expense** (amount, frequency, merchant)
- Outflow periods are **withholding instances** created for each time period
- **Users interact with outflow_periods** for daily financial planning
- Outflows can come from **Plaid** (auto-detected) or **user-created** (manual)

**Example:**
- Outflow: "Internet Bill" with $89.99/month from Comcast (Plaid-synced)
- Outflow Periods: Daily withholding to save for the bill ($3/day)
- User sees: How much to set aside each week/month for upcoming bills

## Architecture

### Module Structure

```
outflows/
├── api/                    # Public-facing Cloud Functions
│   └── crud/              # Create, Read, Update, Delete operations
├── config/                # Configuration constants (placeholder)
├── orchestration/         # Background automation
│   └── triggers/          # Firestore triggers
├── types/                 # TypeScript type definitions (placeholder)
├── utils/                 # Shared business logic (placeholder)
└── admin/                 # Admin and testing functions
```

### Key Concepts

**Outflows (`outflows` collection):**
- **Recurring expense definition** (bill details, frequency, amount)
- Two sources: **Plaid-synced** (auto-detected) or **User-created** (manual)
- Define merchant, amount, frequency (weekly, monthly, etc.)
- Track payment cycles and due dates
- Can be **personal** (no familyId) or **shared** (with familyId)

**Outflow Periods (`outflow_periods` collection):**
- **Primary user interaction point** for financial planning
- Time-based withholding allocations for each period
- Calculate daily withholding rate based on bill frequency
- Track amount to set aside vs amount due in each period
- Support all period types: Monthly, Bi-Monthly, Weekly
- Automatically generated when outflow is created

**Source Periods (`source_periods` collection):**
- Single source of truth for all period definitions
- Pre-generated by admin functions
- Ensures consistency across budgets, outflows, and inflows

**Personal vs Shared Outflows:**
- **Personal Outflows:** Created by/for individual user, `familyId` is null or empty
  - Only the creator can access and modify
  - Outflow periods created for user's planning
  - Used for individual bill tracking
- **Shared Outflows:** Created for family/group, `familyId` is set (future feature)
  - Multiple family members can see the bill
  - Shared financial planning across household
  - Currently being developed

### Outflow → Outflow Period Relationship

```
Outflow (Recurring Bill)
├── description: "Internet Bill"
├── merchantName: "Comcast"
├── averageAmount: $89.99
├── frequency: "MONTHLY" (30 days)
├── outflowSource: "plaid" OR "user"
├── familyId: null (personal) OR "family_123" (shared)
└── Creates → Outflow Periods (Withholding Instances)
    ├── 2025-M01: $89.99 to withhold, due on Jan 31
    ├── 2025-BM01-1: $44.99 to withhold (half month)
    ├── 2025-BM01-2: $44.99 to withhold (half month)
    ├── 2025-W01: $20.97 to withhold (7 days)
    └── ... (all period types for 3 months)
```

**User Workflow:**
1. **Setup Phase:** User creates outflow (manual) or Plaid detects it (auto)
2. **Automatic Generation:** System creates 3 months of outflow_periods
3. **Daily Planning:** User views periods to see withholding amounts
   - Weekly view: "Set aside $20.97 this week for Internet"
   - Monthly view: "Internet bill of $89.99 due Jan 31"
   - Track progress toward upcoming bill payment

## Data Models

### Outflow Document (Recurring Bill Definition)

```typescript
interface RecurringOutflow {
  id: string;

  // Core identification
  streamId: string;                // Plaid stream ID or user-generated ID
  itemId: string;                  // Plaid item ID or 'manual'
  userId: string;                  // Owner user ID
  familyId: string | null;         // Family association (null for personal)
  accountId: string;               // Plaid account ID or 'manual'

  // Stream classification
  isActive: boolean;               // Whether outflow is active
  status: PlaidRecurringTransactionStatus; // MATURE, EARLY_DETECTION, etc.

  // Transaction details
  description: string;             // Bill name/description
  merchantName: string | null;     // Merchant/company name
  category: string[];              // Plaid category hierarchy
  personalFinanceCategory: PlaidPersonalFinanceCategory | null;

  // Amount information
  averageAmount: {
    amount: number;
    isoCurrencyCode: string;
    unofficialCurrencyCode: string | null;
  };
  lastAmount: {
    amount: number;
    isoCurrencyCode: string;
    unofficialCurrencyCode: string | null;
  };

  // Frequency and timing
  frequency: PlaidRecurringFrequency; // WEEKLY, MONTHLY, etc.

  // Historical data
  firstDate: Timestamp;            // First occurrence
  lastDate: Timestamp;             // Last/expected occurrence
  transactionIds: string[];        // Linked Plaid transaction IDs

  // Family Finance specific fields
  userCategory: string | null;     // User-assigned category override
  userNotes: string | null;        // User notes
  tags: string[];                  // User tags
  isHidden: boolean;               // Hide from main views

  // Outflow-specific fields
  expenseType: OutflowExpenseType; // subscription, utility, loan, etc.
  isEssential: boolean;            // Whether expense is essential
  merchantCategory: string | null; // Merchant category
  isCancellable: boolean;          // Can this bill be cancelled?
  reminderDays: number;            // Days before due to send reminder

  // User-created outflow metadata
  isUserCreated?: boolean;         // Flag for user-created vs Plaid
  outflowSource?: 'plaid' | 'user'; // Source of this outflow
  dueDay?: number | null;          // Day of month when due (monthly bills)
  nextDueDate?: Timestamp;         // Next due date

  // Sync metadata
  lastSyncedAt: Timestamp;         // Last Plaid sync
  syncVersion: number;             // Sync version number

  // Timestamps
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

### Outflow Period Document (Withholding Instance)

```typescript
interface OutflowPeriod {
  id: string;                      // Format: "{outflowId}_{periodId}"
  outflowId: string;               // Reference to parent outflow
  periodId: string;                // Period identifier (e.g., "2025-W01")
  sourcePeriodId: string;          // Reference to source_periods
  userId: string;                  // Outflow owner
  familyId: string | null;         // Family association (null for personal)

  // Period context (denormalized for performance)
  periodType: PeriodType;          // WEEKLY, BI_MONTHLY, MONTHLY
  periodStartDate: Timestamp;      // Period start
  periodEndDate: Timestamp;        // Period end

  // Payment cycle information
  cycleStartDate: Timestamp;       // Bill payment cycle start
  cycleEndDate: Timestamp;         // Bill payment cycle end (due date)
  cycleDays: number;               // Days in payment cycle

  // Financial calculations
  billAmount: number;              // Full bill amount for this cycle
  dailyWithholdingRate: number;    // Amount to withhold per day
  amountWithheld: number;          // Amount to withhold in THIS period
  amountDue: number;               // Amount due in THIS period (if due date falls here)

  // Payment status
  isDuePeriod: boolean;            // Is bill due during this period?
  dueDate?: Timestamp;             // Actual due date (if isDuePeriod)
  isActive: boolean;               // Whether period is active

  // Metadata from outflow (denormalized for performance)
  outflowDescription: string;      // Bill name
  outflowMerchantName: string | null; // Merchant name
  outflowExpenseType: OutflowExpenseType; // Expense type
  outflowIsEssential: boolean;     // Is essential expense

  // System fields
  createdAt: Timestamp;
  updatedAt: Timestamp;
  lastCalculated: Timestamp;       // Last calculation timestamp
}
```

## API Functions

### CRUD Operations

#### `createRecurringOutflow` (Callable Function)
**Location:** `api/crud/createRecurringOutflow.ts`
**Auth:** User must be authenticated
**Purpose:** Create a user-defined recurring outflow (manual bill)

**Request:**
```typescript
interface CreateRecurringOutflowRequest {
  description: string;              // Bill name
  merchantName?: string;            // Merchant/company name
  amount: number;                   // Bill amount
  frequency: 'weekly' | 'bi_weekly' | 'monthly' | 'quarterly' | 'yearly';
  expenseType?: 'subscription' | 'utility' | 'loan' | 'rent' | 'insurance' | 'tax' | 'other';
  isEssential?: boolean;            // Whether essential expense
  dueDay?: number;                  // Day of month when due (monthly bills)
  userNotes?: string;               // User notes
  familyId?: string;                // Optional family association
}
```

**Response:**
```typescript
interface CreateRecurringOutflowResponse {
  success: boolean;
  outflowId?: string;
  message?: string;
}
```

**What Happens:**
1. User creates manual recurring bill
2. Outflow document created in `outflows` collection
3. `onOutflowCreated` trigger fires automatically
4. 3 months of outflow_periods generated (monthly, bi-monthly, weekly)
5. User can immediately see withholding amounts in their budget

**Example:**
```typescript
import { getFunctions, httpsCallable } from '@react-native-firebase/functions';

const functions = getFunctions();

const createBill = async () => {
  const createOutflow = httpsCallable(functions, 'createRecurringOutflow');
  const result = await createOutflow({
    description: "Netflix Subscription",
    merchantName: "Netflix",
    amount: 15.99,
    frequency: "monthly",
    expenseType: "subscription",
    isEssential: false,
    dueDay: 15
  });
  return result.data;
};
```

## Orchestration Functions

### Triggers

#### `onOutflowCreated` (Firestore Trigger)
**Location:** `orchestration/triggers/onOutflowCreated.ts`
**Triggered by:** Document creation in `outflows` collection
**Purpose:** Automatically generate outflow_periods when outflow is created
**Memory:** 512MiB, Timeout: 60s

**Process:**
1. Outflow document created (Plaid or user)
2. Trigger fires automatically
3. Calculate payment cycle info (days, daily rate)
4. Query source_periods for next 3 months
5. For each source period:
   - Calculate days in period
   - Calculate withholding amount (daily rate × days)
   - Check if bill is due in this period
   - Create outflow_period document
6. Batch create all outflow_periods

**Payment Cycle Calculation:**
```typescript
// Example: Monthly bill of $90
// Cycle: 30 days
// Daily rate: $90 / 30 = $3/day

// Weekly period (7 days):
// amountWithheld = $3/day × 7 days = $21
// isDuePeriod = false (due date not in this week)
// amountDue = $0

// Monthly period (30 days) with due date:
// amountWithheld = $3/day × 30 days = $90
// isDuePeriod = true (due date falls in this month)
// amountDue = $90
```

**Withholding Calculation Examples:**

**Example 1: Monthly bill viewed weekly**
```typescript
// Internet: $90/month (30-day cycle)
// Daily rate: $90 / 30 = $3/day
// Week 1 (7 days): withhold $21
// Week 2 (7 days): withhold $21
// Week 3 (7 days): withhold $21
// Week 4 (7 days): withhold $21
// Total: $84 (slight variance due to rounding)
```

**Example 2: Weekly bill viewed monthly**
```typescript
// Gym: $25/week (7-day cycle)
// Daily rate: $25 / 7 = $3.57/day
// Monthly period (30 days): withhold $107.10
// Covers ~4.3 weeks of gym payments
```

## Admin Functions

### Testing and Debugging

#### `createTestOutflows` (Admin Function)
**Location:** `admin/createTestOutflows.ts`
**Auth:** None (development only)
**Purpose:** Create sample recurring outflows for testing

**Usage:**
```bash
curl https://us-central1-{project}.cloudfunctions.net/createTestOutflows?userId=USER_ID
```

Creates sample outflows:
- Internet Bill ($89.99/month from Comcast)
- Netflix ($15.99/month)
- Gym Membership ($25/week)

#### `debugOutflowPeriods` (Admin Function)
**Location:** `admin/debugOutflowPeriods.ts`
**Auth:** None (development only)
**Purpose:** Debug outflow period calculations and view detailed info

**Usage:**
```bash
curl https://us-central1-{project}.cloudfunctions.net/debugOutflowPeriods?userId=USER_ID
```

Returns diagnostic information:
- All user outflows with details
- All outflow_periods with calculations
- Payment cycle breakdowns
- Withholding amounts by period type

## Configuration

Currently, configuration is handled inline within each function. Future enhancements will move these to `config/`:

```typescript
// Future: config/outflowConfig.ts

const OUTFLOW_PERIOD_MONTHS = 3;      // Generate 3 months of periods
const DEFAULT_REMINDER_DAYS = 3;      // Remind 3 days before due
const MIN_WITHHOLDING_AMOUNT = 0.01;  // Minimum withholding per period

// Frequency to cycle days mapping
const FREQUENCY_CYCLE_DAYS = {
  WEEKLY: 7,
  BIWEEKLY: 14,
  SEMI_MONTHLY: 15,
  MONTHLY: 30,
  ANNUALLY: 365,
};
```

## Security Rules

### Outflows Collection

```javascript
match /outflows/{outflowId} {
  // Read access - Owner or family member
  allow read: if isAuthenticated() && (
    // Outflow owner
    resource.data.userId == request.auth.uid ||
    // Family member for shared outflows
    (resource.data.familyId != null &&
     resource.data.familyId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.familyId)
  );

  // Create access - Cloud Functions only (Plaid sync or user creation via callable function)
  allow create: if false;

  // Update access - Owner or Admin
  allow update: if isAuthenticated() && (
    resource.data.userId == request.auth.uid ||
    hasRole('admin')
  ) && isValidOutflowUpdate();

  // Delete access - Owner or Admin
  allow delete: if isAuthenticated() && (
    resource.data.userId == request.auth.uid ||
    hasRole('admin')
  );
}

function isValidOutflowUpdate() {
  // Allow updates to user-modifiable fields only
  let allowedFields = [
    'userCategory', 'userNotes', 'tags', 'isHidden',
    'isEssential', 'reminderDays', 'updatedAt'
  ];

  let changedFields = request.resource.data.diff(resource.data).affectedKeys();
  return changedFields.hasOnly(allowedFields);
}
```

### Outflow Periods Collection

```javascript
match /outflow_periods/{periodId} {
  // Read access - Owner or family member
  allow read: if isAuthenticated() && (
    resource.data.userId == request.auth.uid ||
    (resource.data.familyId != null &&
     resource.data.familyId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.familyId)
  );

  // Create access - Cloud Functions only
  allow create: if false;

  // Update access - None (periods are read-only after creation)
  allow update: if false;

  // Delete access - Admin only
  allow delete: if isAuthenticated() && hasRole('admin');
}
```

## Firestore Indexes

### Required Composite Indexes

```json
{
  "indexes": [
    {
      "collectionGroup": "outflows",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "isActive", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "outflows",
      "fields": [
        { "fieldPath": "familyId", "order": "ASCENDING" },
        { "fieldPath": "isActive", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "outflow_periods",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "periodType", "order": "ASCENDING" },
        { "fieldPath": "periodStartDate", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "outflow_periods",
      "fields": [
        { "fieldPath": "outflowId", "order": "ASCENDING" },
        { "fieldPath": "periodId", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "outflow_periods",
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "isDuePeriod", "order": "ASCENDING" },
        { "fieldPath": "dueDate", "order": "ASCENDING" }
      ]
    }
  ]
}
```

## Frontend Integration

### React Native Example

```typescript
import { getFunctions, httpsCallable } from '@react-native-firebase/functions';
import { getFirestore, collection, query, where, onSnapshot } from '@react-native-firebase/firestore';

const functions = getFunctions();
const db = getFirestore();

// Create a user-defined recurring bill
async function createUserBill(billData) {
  try {
    const createOutflow = httpsCallable(functions, 'createRecurringOutflow');
    const result = await createOutflow({
      ...billData,
      // familyId omitted for personal bills
    });
    return result.data;
  } catch (error) {
    console.error('Error creating bill:', error);
    throw error;
  }
}

// Subscribe to user's outflows
function subscribeToUserOutflows(userId, callback) {
  const q = query(
    collection(db, 'outflows'),
    where('userId', '==', userId),
    where('isActive', '==', true)
  );

  return onSnapshot(q, (snapshot) => {
    const outflows = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    callback(outflows);
  });
}

// Subscribe to outflow periods for a specific period type
function subscribeToOutflowPeriods(userId, periodType, callback) {
  const q = query(
    collection(db, 'outflow_periods'),
    where('userId', '==', userId),
    where('periodType', '==', periodType),
    where('isActive', '==', true)
  );

  return onSnapshot(q, (snapshot) => {
    const periods = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    callback(periods);
  });
}

// Get current period's bills
function getCurrentPeriodBills(outflowPeriods) {
  const now = new Date();
  return outflowPeriods.filter(period => {
    const start = period.periodStartDate.toDate();
    const end = period.periodEndDate.toDate();
    return now >= start && now <= end;
  });
}

// Calculate total withholding for current period
function calculateTotalWithholding(currentPeriodBills) {
  return currentPeriodBills.reduce((total, bill) => {
    return total + bill.amountWithheld;
  }, 0);
}

// Get upcoming bills (due in current period)
function getUpcomingBills(currentPeriodBills) {
  return currentPeriodBills.filter(bill => bill.isDuePeriod);
}

// Example: Bills screen showing current weekly bills
function WeeklyBillsScreen() {
  const [outflowPeriods, setOutflowPeriods] = useState([]);
  const userId = auth().currentUser.uid;

  useEffect(() => {
    const unsubscribe = subscribeToOutflowPeriods(userId, 'WEEKLY', setOutflowPeriods);
    return () => unsubscribe();
  }, [userId]);

  const currentPeriodBills = getCurrentPeriodBills(outflowPeriods);
  const totalWithholding = calculateTotalWithholding(currentPeriodBills);
  const upcomingBills = getUpcomingBills(currentPeriodBills);

  return (
    <View>
      <Text>This Week's Bill Planning</Text>
      <Text>Total to set aside: ${totalWithholding.toFixed(2)}</Text>

      <Text>Bills to pay this week:</Text>
      {upcomingBills.map(bill => (
        <View key={bill.id}>
          <Text>{bill.outflowDescription}</Text>
          <Text>Due: {bill.dueDate?.toDate().toLocaleDateString()}</Text>
          <Text>Amount: ${bill.amountDue.toFixed(2)}</Text>
        </View>
      ))}

      <Text>Bills to save for:</Text>
      {currentPeriodBills.filter(b => !b.isDuePeriod).map(bill => (
        <View key={bill.id}>
          <Text>{bill.outflowDescription}</Text>
          <Text>Set aside: ${bill.amountWithheld.toFixed(2)}</Text>
        </View>
      ))}
    </View>
  );
}
```

## Common Workflows

### Creating a User-Defined Bill

1. **User creates recurring bill** via `createRecurringOutflow` function
   - Defines name, amount, frequency, due day
   - One-time setup action
2. **`onOutflowCreated` trigger fires** automatically
   - Calculates payment cycle and daily withholding rate
3. **Outflow period instances generated** from source_periods
   - 3 months of monthly, bi-monthly, and weekly instances created
4. **User can now view** withholding amounts in their budget
   - See how much to set aside each week/month
   - Track upcoming bill due dates

### Daily Bill Planning

1. **User opens bills screen** → Views current outflow_periods
2. **System shows withholding amounts** for selected period type
3. **User sees upcoming bills** with due dates in current period
4. **User plans finances** based on withholding recommendations
5. **Real-time listeners** update when new bills added

### Plaid-Detected Recurring Transaction

1. **Plaid detects recurring pattern** in user transactions
2. **Plaid webhook** notifies system
3. **Recurring outflow created** in `outflows` collection
4. **`onOutflowCreated` trigger fires** automatically
5. **Outflow_periods generated** for planning
6. **User sees new bill** in their outflows list

## Performance Considerations

### Optimization Strategies

**Period Generation:**
- Batch writes (500 documents per batch)
- Generate only 3 months ahead to minimize writes
- Efficient date range queries on indexed fields

**Withholding Calculations:**
- Daily rate calculated once per outflow
- Simple multiplication for period amounts
- Denormalized outflow data avoids joins

**Real-time Updates:**
- Firestore listeners for live data
- Client-side calculations reduce function calls
- Minimal document size for fast queries

### Scaling Limits

**Outflow Periods per Outflow:**
- Typical: ~20 periods per outflow (3 months × all types)
- Maximum: Depends on period generation strategy
- Cleanup: Archive old periods after 6 months (future)

**Performance:**
- Period creation: O(n) where n = source periods (3 months)
- Batch size: 500 documents per write
- Query efficiency: Indexed by userId, periodType, dates

## Error Handling

### Common Errors

**"No source periods found in date range"**
- **Cause:** Admin hasn't generated source_periods for timeframe
- **Solution:** Run `generateSourcePeriods` admin function
- **Prevention:** Generate periods 1+ year in advance

**"User must be authenticated"**
- **Cause:** Missing or invalid auth token
- **Solution:** Ensure user is logged in
- **Prevention:** Check auth state before function calls

**"Invalid frequency"**
- **Cause:** Unsupported frequency value
- **Solution:** Use valid frequency (weekly, bi_weekly, monthly, quarterly, yearly)

### Debugging Tips

**Outflow periods not showing:**
```bash
# Check if source_periods exist
firebase firestore:get source_periods

# Check outflow document
firebase firestore:get outflows/{outflowId}

# View trigger logs
firebase functions:log --only onOutflowCreated
```

**Incorrect withholding calculations:**
```bash
# Use debug function
curl https://us-central1-{project}.cloudfunctions.net/debugOutflowPeriods?userId=USER_ID

# Check payment cycle calculation
# Verify daily rate: billAmount / cycleDays
# Verify period amount: dailyRate × daysInPeriod
```

## Development Guidelines

### Adding New Outflow Features

1. **Update types** in `/src/types/index.ts` (core types) or `types/` (outflow-specific)
2. **Determine feature location:**
   - User-facing: `api/crud/` or `api/queries/`
   - Background automation: `orchestration/triggers/` or `orchestration/scheduled/`
   - Admin/testing: `admin/`
   - Shared logic: `utils/`
   - Configuration: `config/`
3. **Update security rules** in `firestore.rules`
4. **Add indexes** in `firestore.indexes.json` if needed
5. **Update this documentation** with new features
6. **Test thoroughly** in emulator

### Best Practices

**Outflow Creation:**
- Validate frequency and amount
- Set sensible defaults (reminderDays: 3, isEssential: false)
- Include comprehensive error messages
- Support both Plaid and user sources

**Period Generation:**
- Trust source_periods as single source of truth
- Use batch operations for bulk creates
- Calculate withholding based on actual period days
- Log detailed calculation steps for debugging

**Withholding Calculations:**
- Always use dailyRate × daysInPeriod for accuracy
- Round to 2 decimal places for currency
- Handle edge cases (leap years, varying month lengths)
- Denormalize outflow data in periods for performance

**User Experience:**
- Make withholding amounts easy to understand
- Clearly show due dates and amounts due
- Separate "bills to pay" from "bills to save for"
- Provide financial planning insights

## Future Enhancements

### Planned Features

**Payment Tracking:**
- Mark bills as paid in outflow_periods
- Track payment history
- Auto-detect payments from linked accounts
- Payment reminders and notifications

**Smart Recommendations:**
- Suggest optimal withholding strategy
- Alert when bills are increasing
- Identify cancellable subscriptions
- Budget optimization suggestions

**Family Collaboration:**
- Shared household bills
- Split bill responsibilities
- Family bill dashboard
- Payment tracking across family members

**Advanced Analytics:**
- Bill spending trends over time
- Category breakdown of recurring expenses
- Essential vs non-essential analysis
- Year-over-year comparisons

**Utilities:**
- `utils/outflowPeriods.ts` - Period calculation utilities
- `utils/outflowSpending.ts` - Payment tracking
- `utils/calculateWithholding.ts` - Withholding strategies

**Configuration:**
- `config/outflowConfig.ts` - Central configuration
- Configurable period generation length
- Reminder customization
- Withholding strategy options

## Transaction Split Assignment to Outflows

### Multi-Period Assignment Architecture

The system supports assigning transaction splits to outflow periods across ALL THREE period types (monthly, weekly, bi-weekly) simultaneously. This ensures consistency across different period views.

**Key Concepts:**
- **Bi-directional References:** Transaction splits store outflow period IDs; outflow periods store transaction split references
- **Multi-Period Assignment:** One transaction split can be assigned to all three period types at once
- **Payment Date Tracking:** Each split includes `paymentDate` matching the transaction date
- **Advance Payment Support:** Users can manually specify target periods for advance payments

### Transaction Split Interface

```typescript
interface TransactionSplit {
  id: string;

  // Budget assignment
  budgetId: string;
  budgetName: string;

  // Outflow assignment (all three period types)
  outflowId?: string;                    // Parent outflow ID
  outflowDescription?: string;           // Denormalized outflow description
  outflowPeriodId?: string;              // Primary period reference (monthly preferred)
  outflowMonthlyPeriodId?: string;       // Monthly period ID
  outflowWeeklyPeriodId?: string;        // Weekly period ID
  outflowBiWeeklyPeriodId?: string;      // Bi-weekly period ID

  // Payment tracking
  paymentType?: PaymentType;             // regular, catch_up, advance, extra_principal
  paymentDate?: Timestamp;               // Date when payment was made (matches transaction.date)

  // Other fields...
  amount: number;
  categoryId: string;
  description?: string;
  isDefault: boolean;

  createdAt: Timestamp;
  updatedAt: Timestamp;
  createdBy: string;
}
```

### TransactionSplitReference Interface

Stored in outflow_periods to track assigned payments:

```typescript
interface TransactionSplitReference {
  transactionId: string;           // Reference to transactions document
  splitId: string;                 // Specific split within transaction
  transactionDate: Timestamp;      // When transaction occurred
  amount: number;                  // Split amount
  description: string;             // Transaction description
  paymentType: PaymentType;        // Payment classification
  isAutoMatched: boolean;          // Was this auto-matched or manual?
  matchedAt: Timestamp;            // When assignment occurred
  matchedBy: string;               // User ID or 'system'
}
```

### API Functions for Split Assignment

#### `assignSplitToAllOutflowPeriods` (Callable Function)
**Location:** `api/assignSplitToAllOutflowPeriods.ts`
**Auth:** EDITOR role required
**Purpose:** Assign a transaction split to ALL three outflow period types simultaneously

**Request:**
```typescript
interface AssignSplitToAllOutflowPeriodsRequest {
  transactionId: string;              // Transaction containing the split
  splitId: string;                    // Specific split to assign
  outflowId: string;                  // Parent outflow ID (not period ID!)
  paymentType?: PaymentType;          // regular, catch_up, advance, extra_principal
  clearBudgetAssignment?: boolean;    // Clear budget fields when moving to outflow
  targetPeriodId?: string;            // Optional: Specific period for advance payments
}
```

**Response:**
```typescript
interface AssignSplitToAllOutflowPeriodsResponse {
  success: boolean;
  split?: TransactionSplit;           // Updated split with all period references
  monthlyPeriod?: OutflowPeriod;      // Monthly period (if found)
  weeklyPeriod?: OutflowPeriod;       // Weekly period (if found)
  biWeeklyPeriod?: OutflowPeriod;     // Bi-weekly period (if found)
  periodsUpdated: number;             // Count of periods updated
  message?: string;
}
```

**What Happens:**
1. Validates transaction, split, and outflow ownership
2. Finds all three matching outflow periods:
   - **Without targetPeriodId:** Matches based on transaction date
   - **With targetPeriodId:** Matches based on source period overlap (for advance payments)
3. Updates transaction split with ALL period references:
   - Sets `outflowId`, `outflowDescription`
   - Sets `outflowPeriodId` (primary reference)
   - Sets `outflowMonthlyPeriodId`, `outflowWeeklyPeriodId`, `outflowBiWeeklyPeriodId`
   - Sets `paymentType` and `paymentDate`
   - Optionally clears `budgetId` and `budgetName`
4. Adds `TransactionSplitReference` to all three outflow periods
5. Recalculates status for all updated periods

**Example Usage:**
```typescript
// Regular payment (auto-detect periods from transaction date)
const result = await assignSplitToAllOutflowPeriods({
  transactionId: "txn_123",
  splitId: "split_456",
  outflowId: "outflow_789",
  paymentType: "regular",
  clearBudgetAssignment: true
});

// Advance payment (manually specify target period)
const result = await assignSplitToAllOutflowPeriods({
  transactionId: "txn_123",
  splitId: "split_456",
  outflowId: "outflow_789",
  paymentType: "advance",
  targetPeriodId: "2025-M10",  // October 2025 monthly period
  clearBudgetAssignment: true
});
```

#### `unassignSplitFromAllOutflowPeriods` (Callable Function)
**Location:** `api/unassignSplitFromAllOutflowPeriods.ts`
**Auth:** EDITOR role required
**Purpose:** Remove a transaction split assignment from ALL outflow periods

**Request:**
```typescript
interface UnassignSplitFromAllOutflowPeriodsRequest {
  transactionId: string;
  splitId: string;
  restoreBudgetAssignment?: boolean;  // Restore original budget assignment
}
```

**Response:**
```typescript
interface UnassignSplitFromAllOutflowPeriodsResponse {
  success: boolean;
  split?: TransactionSplit;
  periodsUpdated: number;
  message?: string;
}
```

**What Happens:**
1. Retrieves transaction and validates ownership
2. Finds split and extracts all three period IDs
3. Clears outflow assignment from split:
   - Removes `outflowId`, `outflowDescription`
   - Removes all period ID references
   - Removes `paymentType` and `paymentDate`
   - Optionally restores `budgetId` and `budgetName`
4. Removes `TransactionSplitReference` from all three outflow periods
5. Recalculates status for all affected periods

### Utility Functions

#### `findMatchingOutflowPeriods`
**Location:** `utils/findMatchingOutflowPeriods.ts`
**Purpose:** Find all three period types based on transaction date

```typescript
interface MatchingOutflowPeriodsResult {
  monthlyPeriodId: string | null;
  weeklyPeriodId: string | null;
  biWeeklyPeriodId: string | null;
  foundCount: number;
}

async function findMatchingOutflowPeriods(
  db: Firestore,
  outflowId: string,
  transactionDate: Timestamp
): Promise<MatchingOutflowPeriodsResult>
```

**Logic:**
- Queries `outflow_periods` where transaction date falls within period range
- Separates results by `periodType` (MONTHLY, WEEKLY, BI_MONTHLY)
- Returns all three period IDs (or null if not found)
- Logs warning if fewer than 3 periods found

#### `findMatchingOutflowPeriodsBySourcePeriod`
**Location:** `utils/findMatchingOutflowPeriods.ts`
**Purpose:** Find all three period types based on a target source period

```typescript
async function findMatchingOutflowPeriodsBySourcePeriod(
  db: Firestore,
  outflowId: string,
  targetPeriodId: string
): Promise<MatchingOutflowPeriodsResult>
```

**Logic:**
1. Fetches source period to get date range
2. Queries `outflow_periods` where period overlaps with source period range
3. Prefers exact matches (where `periodId === targetPeriodId`)
4. Returns all three period types that overlap with target period

**Use Case:** Advance payments where user pays multiple periods ahead
- User pays $300 for 3 months rent
- Creates 3 separate splits from one transaction
- Each split assigned to different monthly period using `targetPeriodId`

#### `validatePeriodsFound`
**Location:** `utils/findMatchingOutflowPeriods.ts`
**Purpose:** Validate at least one period was found

```typescript
function validatePeriodsFound(result: MatchingOutflowPeriodsResult): void {
  if (result.foundCount === 0) {
    throw new Error('No matching outflow periods found...');
  }
}
```

#### `calculateOutflowPeriodStatus`
**Location:** `utils/calculateOutflowPeriodStatus.ts`
**Purpose:** Calculate period status based on payments and due dates

```typescript
type OutflowPeriodStatus = 'pending' | 'partial' | 'paid' | 'overdue' | 'not_due';

function calculateOutflowPeriodStatus(
  isDuePeriod: boolean,
  dueDate: Timestamp | undefined,
  expectedDueDate: Timestamp | undefined,
  amountDue: number,
  transactionSplits: TransactionSplitReference[]
): OutflowPeriodStatus
```

**Status Logic:**
- **not_due:** Not a due period (no payment expected)
- **pending:** Due period with no payments
- **partial:** Due period with some payment (< amount due)
- **paid:** Due period with full payment (≥ amount due)
- **overdue:** Past due date with insufficient payment

### Payment Types

```typescript
enum PaymentType {
  REGULAR = 'regular',              // Normal on-time payment
  CATCH_UP = 'catch_up',            // Payment for past-due bill
  ADVANCE = 'advance',              // Payment made well before due date
  EXTRA_PRINCIPAL = 'extra_principal' // Extra payment beyond required amount
}
```

**Auto-Detection Logic (in auto-match):**
- **EXTRA_PRINCIPAL:** Amount > bill amount × 1.1 (10% tolerance)
- **CATCH_UP:** Payment before due date, but due date has passed
- **ADVANCE:** Payment > 7 days before due date
- **REGULAR:** All other payments

### Payment Date Tracking

**All transaction splits include `paymentDate` field:**
- Set when split is created (matches `transaction.date`)
- Preserved when split is assigned to outflows
- Ensures consistent payment tracking across all operations

**Updated in all split creation points:**
1. `formatTransactions.ts` - Plaid transaction import
2. `migrateTransactionsToSplits.ts` - Migration of existing transactions
3. `assignSplitToAllOutflowPeriods.ts` - Manual outflow assignment
4. `autoMatchTransactionToOutflowPeriods.ts` - Auto-matching historical transactions

### Common Workflows

#### Assigning a Payment to a Bill

1. **User marks transaction as bill payment:**
   - Opens transaction detail screen
   - Selects "Assign to Bill"
   - Chooses outflow from list
   - Selects payment type

2. **System assigns to all period types:**
   - Calls `assignSplitToAllOutflowPeriods`
   - Finds matching monthly, weekly, bi-weekly periods
   - Updates transaction split with all references
   - Adds payment to all three outflow periods
   - Recalculates status (pending → paid)

3. **User sees updated status:**
   - Monthly view: "Internet Bill - Paid"
   - Weekly view: "Internet Bill - Paid"
   - Bi-weekly view: "Internet Bill - Paid"
   - All views stay in sync

#### Paying Multiple Periods in Advance

1. **User pays 3 months rent ($3,000):**
   - Transaction imported from bank
   - Total amount: $3,000

2. **User creates 3 splits:**
   - Split 1: $1,000 for October 2025
   - Split 2: $1,000 for November 2025
   - Split 3: $1,000 for December 2025

3. **Assigns each split to target period:**
   ```typescript
   // October rent
   await assignSplitToAllOutflowPeriods({
     transactionId: "txn_123",
     splitId: "split_1",
     outflowId: "rent_outflow",
     paymentType: "advance",
     targetPeriodId: "2025-M10"  // October source period
   });

   // November rent
   await assignSplitToAllOutflowPeriods({
     transactionId: "txn_123",
     splitId: "split_2",
     outflowId: "rent_outflow",
     paymentType: "advance",
     targetPeriodId: "2025-M11"  // November source period
   });

   // December rent
   await assignSplitToAllOutflowPeriods({
     transactionId: "txn_123",
     splitId: "split_3",
     outflowId: "rent_outflow",
     paymentType: "advance",
     targetPeriodId: "2025-M12"  // December source period
   });
   ```

4. **System updates all periods:**
   - Each split assigned to its target monthly period
   - Also assigned to overlapping weekly/bi-weekly periods
   - All three months show as paid in advance

#### Unassigning an Incorrect Payment

1. **User realizes mistake:**
   - Assigned wrong transaction to bill
   - Opens transaction detail

2. **User removes assignment:**
   - Taps "Unassign from Bill"
   - Confirms action

3. **System clears assignment:**
   - Calls `unassignSplitFromAllOutflowPeriods`
   - Removes split from all three period types
   - Restores original budget assignment
   - Recalculates period status (paid → pending)

### Auto-Matching Historical Transactions

When an outflow is created (Plaid-detected), the system automatically matches historical transactions:

**Process:**
1. `onOutflowCreated` trigger fires
2. After creating periods, calls `orchestrateAutoMatchingWorkflow`
3. Fetches all transactions in `outflow.transactionIds` array
4. For each transaction:
   - Finds matching outflow period based on date
   - Determines payment type (regular, catch_up, advance)
   - Assigns split to appropriate period
   - Sets `paymentDate` to match transaction date
5. Recalculates all period statuses

**Auto-Match Configuration:**
- Only matches unassigned splits
- Skips splits already assigned to budgets or other outflows
- Marks as `isAutoMatched: true` in `TransactionSplitReference`
- Logs all matches for debugging

### Performance Considerations

**Multi-Period Assignment:**
- Uses batch operations for atomic updates
- Maximum 3 periods updated per assignment (one per type)
- Efficient queries using indexed fields

**Status Recalculation:**
- Only recalculates affected periods
- Uses denormalized data to avoid joins
- Simple aggregation of split amounts

**Payment Tracking:**
- `paymentDate` stored directly on splits (no additional queries)
- Consistent across all operations
- Enables historical payment analysis

## Notes for AI Assistants

- **Outflows are recurring bills** - they define the expense pattern
- **Outflow periods are withholding instances** - users interact with these
- **Always generate 3 months of periods** when outflow is created
- **Personal outflows have familyId: null** - not empty string like budgets
- **Withholding calculation:** dailyRate × daysInPeriod
- **Payment cycle:** Determines daily rate (billAmount / cycleDays)
- **Two sources:** Plaid-synced (auto) or user-created (manual)
- **Check source_periods exist** before generating outflow_periods
- **Use batch operations** for bulk period creation
- **Denormalize outflow data** in periods for performance
- **Log comprehensively** for debugging calculations
- **Test security rules** thoroughly
- **Document breaking changes** and migration strategies
- **Focus on individual users first** - family features come later
- **Match budgets structure** for consistency across modules
- **CRITICAL: Multi-period assignment** - Always assign splits to ALL THREE period types (monthly, weekly, bi-weekly)
- **CRITICAL: Payment date tracking** - Always set `paymentDate` field on splits to match `transaction.date`
- **Bi-directional references** - Splits store period IDs, periods store split references
- **Advance payment support** - Use `targetPeriodId` to manually specify periods for advance payments
- **Payment type auto-detection** - System determines payment type based on amount and timing
- **Status recalculation** - Always recalculate period status after assignment/unassignment changes
