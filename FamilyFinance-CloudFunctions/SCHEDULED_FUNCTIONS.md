# Scheduled Functions Documentation

## Overview

This document describes the scheduled Firebase Cloud Functions in the FamilyFinance project.

## updateCurrentPeriods

**Function**: `updateCurrentPeriods`  
**Schedule**: Daily at midnight UTC (00:00)  
**Purpose**: Automatically update the `isCurrent` flag for source periods

### Functionality

The function performs the following operations daily:

1. **Query all source periods** from the `source_periods` collection
2. **Identify current periods** - periods where today's date falls between `startDate` and `endDate`
3. **Update flags efficiently** - only updates periods that need to change:
   - Sets previously current periods to `isCurrent: false` 
   - Sets newly current periods to `isCurrent: true`
4. **Use batch operations** for optimal performance (max 500 operations per batch)
5. **Log comprehensive details** about the updates performed

### Expected Behavior

On each execution, the function should find exactly **3 current periods**:
- 1 current monthly period
- 1 current weekly period (Sunday-Saturday)
- 1 current bi-monthly period (1st-15th or 16th-end of month)

### Performance Characteristics

- **Memory**: 512MiB allocated
- **Timeout**: 5 minutes maximum
- **Batch size**: 500 operations per batch
- **Optimization**: Only updates periods that actually need to change

### Monitoring

#### Function Logs
```bash
# View recent logs
firebase functions:log --only updateCurrentPeriods

# View real-time logs
firebase functions:log --only updateCurrentPeriods --tail
```

#### Key Log Messages
- `Starting updateCurrentPeriods function` - Function execution begins
- `Found X source periods to process` - Total periods in database
- `No period updates needed` - All periods already correct (rare)
- `Committed batch X: Y updates` - Batch operations completed
- `Current {type} period` - Details of each current period found
- `updateCurrentPeriods function completed successfully` - Execution summary

#### Warning Indicators
- `No source periods found` - Database may be empty
- `No current {type} period found` - Missing periods for current date
- Function timeout or memory errors - May need resource adjustment

### Error Handling

The function includes:
- **Automatic retries** - Firebase Functions retry policy
- **Comprehensive error logging** - Full stack traces logged
- **Graceful failure** - Failed executions don't affect database consistency
- **Transaction safety** - Batch operations ensure atomicity

### Manual Execution

For testing or emergency updates:

```bash
# Test the logic locally (requires Firebase setup)
npx ts-node src/scripts/test-update-current-periods.ts

# Deploy function only
node src/scripts/deploy-update-current-periods.js

# Trigger manually (Firebase Console or API)
# Note: Scheduled functions cannot be triggered via CLI
```

### Dependencies

- **Firebase Admin SDK** - Firestore operations
- **Source periods data** - Generated by `generateSourcePeriods` function
- **Firestore indexes** - Optimized queries on `startDate` and `endDate`

### Related Functions

- `generateSourcePeriods` - Creates the source period data this function operates on
- Any budget/reporting functions that depend on `isCurrent` flags

### Configuration

The function configuration can be found in:
- **Function definition**: `src/functions/admin/updateCurrentPeriods.ts`
- **Export**: `src/functions/admin/index.ts`
- **Schedule**: Cron expression `"0 0 * * *"` (daily at midnight UTC)
- **Region**: `us-central1`

### Troubleshooting

#### Common Issues

1. **Function not running**
   - Check Firebase console for scheduled function status
   - Verify Firebase billing is enabled (required for scheduled functions)
   - Check function deployment logs

2. **Incorrect current periods**
   - Verify source periods exist for current date range
   - Check timezone handling (all dates stored in UTC)
   - Review source period generation logic

3. **Performance issues**
   - Monitor function execution time and memory usage
   - Consider increasing memory allocation if needed
   - Review batch size optimization

#### Debugging Steps

1. Check function logs for errors
2. Verify source periods exist: Query `source_periods` collection
3. Test logic locally: Run test script
4. Manual verification: Check `isCurrent` flags in Firestore console
5. Compare with expected periods for current date

### Future Enhancements

Potential improvements:
- **Smart scheduling** - Skip execution if no updates needed
- **Metrics collection** - Track execution statistics
- **Alert integration** - Notify on failures or anomalies
- **Timezone support** - Handle family-specific timezones
- **Bulk optimization** - Process only changed periods based on date deltas